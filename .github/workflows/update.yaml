name: Update Strings
on:
  schedule:
    - cron: '0 7 * * 1-5' # Run Mon-Fri at 7AM UTC
  workflow_dispatch:
    inputs:
      type:
        description: Type of update (standard, nofile, matchid)
        required: true
        default: "standard"
jobs:
  extract:
    name: Extract strings
    runs-on: ubuntu-latest
    env:
      QTVERSION: 6.2.4
    steps:
      - name: Clone l10n repository
        uses: actions/checkout@v3
        with:
          path: "translationFiles"
      - name: Install Qt
        run: |
          python3 -m pip install aqtinstall
          python3 -m aqt install-qt -O /opt linux desktop $QTVERSION
      - name: Clone main code repository
        uses: actions/checkout@v3
        with:
          repository: "mozilla-mobile/mozilla-vpn-client"
          fetch-depth: 0
          path: "vpn"
      - name: Set up Python 3
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'
      - name: Install Python dependencies
        run: |
          pip install -r translationFiles/.github/scripts/requirements.txt
      - name: Extract new strings
        run: |
          # Manually add QT executables to path
          export PATH=/opt/$QTVERSION/gcc_64/bin:$PATH

          # Extract strings for default and release branches
          (cd vpn && ./scripts/utils/generate_ts.sh)
          mv vpn/translations.ts .

          # Convert to XLIFF and update other locales
          python translationFiles/.github/scripts/extract_source_strings.py --input translations.ts --output translationFiles/en/mozillavpn.xliff
          python translationFiles/.github/scripts/update_other_locales.py --reference en --path translationFiles/ --type "${{ github.event.inputs.type }}"

          # Addons
          if [ -f vpn/scripts/addon/generate_all.py ]; then
            python "vpn/scripts/addon/generate_all.py"
            mkdir -p "translationFiles/en/addons"
            for i in "vpn/addons/generated/addons/*.ts; do
              ADDONID=$(basename $i | sed "s/.ts$//")
              echo "Generating language for addon $ADDONID"
              mkdir -p "$TRANSLATIONS/en/addons/$ADDONID"
              python "translationFiles/.github/scripts/extract_source_strings.py" --input "$i" --output "translationFiles/en/addons/$ADDONID/locale.xliff"
              python "translationFiles/.github/scripts/update_other_locales.py" --reference en --xliff "addons/$ADDONID/locale.xliff" --path translationFiles/ --type "${{ github.event.inputs.type }}"
            done
          fi

      - run : git config --global user.email 'flodolo@users.noreply.github.com'
      - uses: peter-evans/create-pull-request@v4
        with:
          path: "translationFiles"
          commit-message: "Extract new strings and update all locales"
          branch: l10n_automation
          delete-branch: true
          title: "Extract new strings"
